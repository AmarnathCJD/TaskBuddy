<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>My Tasks - AmarnathCJD</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <meta name="theme-color" content="#0b0f12" />
    <meta name="description" content="A simple task management app with local storage support.
    Add, edit, and delete tasks with priority and deadline features. Tasks persist in your browser
    and can be reordered by dragging.">
    <meta name="keywords" content="todo, task manager, local storage, drag and
    drop, priority, deadline, simple todo app, minimal todo app">
    <meta name="author" content="AmarnathCJD">
    <meta name="robots" content="index, follow">

    <style>
        :root {
            --bg: #0b0f12;
            --card: #0f1417;
            --muted: #98a0a6;
            --accent: #6ee7b7;
            --danger: #ff6b6b;
            --glass: rgba(255, 255, 255, 0.03);
            font-family: 'Poppins', sans-serif;
        }

        * {
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        body {
            margin: 0;
            min-height: 100vh;
            background:
                radial-gradient(800px 400px at 10% 10%, rgba(110, 231, 183, 0.04), transparent 10%),
                radial-gradient(700px 350px at 90% 90%, rgba(106, 97, 255, 0.03), transparent 10%),
                var(--bg);
            color: #e6eef3;
            -webkit-font-smoothing: antialiased;
            padding: 16px;
        }

        .wrap {
            max-width: 980px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
            flex-wrap: wrap;
            gap: 8px;
        }

        h1 {
            margin: 0;
            font-size: clamp(18px, 4vw, 22px);
            letter-spacing: 0.2px;
            margin-bottom: 5px;
        }

        .sub {
            color: var(--muted);
            font-size: clamp(12px, 3vw, 13px);
        }

        .panel {
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
            border-radius: 12px;
            padding: 14px;
            border: 1px solid rgba(255, 255, 255, 0.03);
            box-shadow: 0 6px 18px rgba(2, 6, 8, 0.6);
        }

        form .row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        input,
        textarea,
        select,
        button {
            background: var(--glass);
            border: 1px solid rgba(255, 255, 255, 0.04);
            color: inherit;
            padding: 10px 12px;
            border-radius: 8px;
            font-size: clamp(14px, 3vw, 15px);
            transition: all 0.2s ease;
            width: 100%;
        }


        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(110, 231, 183, 0.15);
        }

        select {
            appearance: none;
            background-color: #222;
            cursor: pointer;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        label {
            font-size: 13px;
            color: var(--muted);
            display: block;
            margin-bottom: 6px;
        }

        .btn {
            cursor: pointer;
            padding: 10px 12px;
            border-radius: 10px;
            border: none;
            background: transparent;
            color: var(--accent);
            font-weight: 600;
            transition: all 0.2s ease;
            font-size: clamp(14px, 3vw, 15px);
            white-space: nowrap;
        }

        .btn:hover {
            background: rgba(110, 231, 183, 0.08);
        }

        .btn.ghost {
            color: var(--muted)
        }

        .btn.danger {
            color: var(--danger)
        }

        .small {
            font-size: 13px;
            padding: 8px 10px;
        }

        .list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
            max-height: 50dvh;
            overflow-y: auto;
            padding-right: 4px;
        }

        .list::-webkit-scrollbar {
            width: 6px;
        }

        .list::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 3px;
        }

        .list::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .list::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .task {
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.012), rgba(255, 255, 255, 0.008));
            padding: 12px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.03);
            display: flex;
            gap: 12px;
            align-items: flex-start;
            cursor: grab;
            transition: background 0.2s ease;
            flex-wrap: wrap;
        }

        .task.subtask {
            margin-left: 24px;
            padding: 10px;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.006), rgba(255, 255, 255, 0.003));
            border-left: 2px solid rgba(110, 231, 183, 0.3);
            border-radius: 8px;
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.02);
        }

        .task.subtask::before {
            content: '';
            position: absolute;
            left: -27px;
            top: 20px;
            width: 20px;
            height: 1px;
            background: rgba(255, 255, 255, 0.15);
        }

        .task.subtask::after {
            content: '';
            position: absolute;
            left: -27px;
            top: -10px;
            width: 1px;
            height: 30px;
            background: rgba(255, 255, 255, 0.15);
        }

        .subtask-toggle {
            background: none;
            border: none;
            color: var(--muted);
            cursor: pointer;
            font-size: 11px;
            padding: 6px 0;
            transition: all 0.2s ease;
            font-weight: 500;
            width: fit-content;
            margin-top: 8px;
            display: block;
            opacity: 0.7;
        }

        .subtask-toggle:hover {
            color: var(--accent);
            opacity: 1;
        }

        .task:hover {
            background: rgba(255, 255, 255, 0.04);
        }

        .task:active {
            transform: scale(0.98);
            transition: transform 0.1s ease;
        }

        .task.dragging {
            opacity: 0.5;
            transform: scale(0.995)
        }

        .task.done {
            opacity: 0.7;
        }

        .task.done .meta .title,
        .task.done .meta .desc {
            text-decoration: line-through;
            color: var(--muted);
        }

        .task .meta {
            flex: 1;
            min-width: 200px;
        }

        .title {
            font-size: 15px;
            font-weight: 600;
            word-break: break-word;
            transition: all 0.2s ease;
        }

        .desc {
            font-size: 13px;
            color: var(--muted);
            margin-top: 6px;
            word-break: break-word;
            transition: all 0.2s ease;
        }

        .right {
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: flex-end;
            min-width: 120px;
        }

        .pill {
            font-size: 12px;
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.03);
            background: rgba(0, 0, 0, 0.12);
            white-space: nowrap;
        }

        .prio-low {
            color: #9ae6b4;
        }

        .prio-med {
            color: #f6e05e;
        }

        .prio-high {
            color: #feb2b2;
        }

        .countdown {
            font-size: 11px;
            color: var(--muted);
            margin-top: 4px;
            font-weight: 500;
        }

        .countdown.urgent {
            color: var(--danger);
        }

        .countdown.warning {
            color: #f6e05e;
        }

        footer {
            margin-top: 18px;
            color: var(--muted);
            font-size: 13px;
            text-align: center;
        }

        .form-row {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .form-col {
            flex: 1;
            min-width: 150px;
        }

        .actions {
            display: flex;
            gap: 8px;
            margin-top: auto;
            flex-wrap: wrap;
        }

        .actions button {
            width: auto;
            flex: 1;
        }

        input[type="file"] {
            display: block;
            background: var(--glass);
            border: 1px solid rgba(255, 255, 255, 0.04);
            color: var(--muted);
            padding: 8px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
        }

        input[type="file"]::-webkit-file-upload-button {
            background: var(--glass);
            border: 1px solid rgba(255, 255, 255, 0.04);
            color: var(--accent);
            padding: 4px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
        }

        input[type="file"]:hover::-webkit-file-upload-button {
            background: rgba(110, 231, 183, 0.08);
        }

        @media (max-width: 640px) {
            body {
                padding: 12px;
            }

            .panel {
                padding: 12px;
            }

            .task {
                flex-direction: column;
                gap: 8px;
                padding: 12px;
                border-radius: 12px;
                background: linear-gradient(135deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
                border: 1px solid rgba(255, 255, 255, 0.06);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            }

            .task .meta {
                min-width: unset;
                width: 100%;
            }

            .task .title {
                font-size: 15px;
                font-weight: 600;
                margin-bottom: 4px;
            }

            .task .desc {
                font-size: 13px;
                line-height: 1.3;
                margin-top: 2px;
                margin-bottom: 4px;
            }

            .right {
                width: 100%;
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                gap: 8px;
                flex-wrap: wrap;
            }

            .pill {
                order: 1;
                flex-shrink: 0;
                padding: 6px 10px;
                font-size: 10px;
                font-weight: 600;
                border-radius: 20px;
            }

            .actions {
                order: 2;
                display: flex;
                gap: 6px;
                flex: 1;
                min-width: 120px;
            }

            .actions button {
                flex: 1;
                padding: 8px 10px;
                font-size: 13px;
                border-radius: 6px;
                font-weight: 500;
            }

            .countdown {
                font-size: 11px;
                margin-top: 4px;
                padding: 3px 6px;
                background: rgba(255, 255, 255, 0.03);
                border-radius: 4px;
                display: inline-block;
            }

            .task.subtask {
                margin-left: 12px;
                padding: 10px;
                border-left: 2px solid rgba(110, 231, 183, 0.4);
                background: linear-gradient(135deg, rgba(255, 255, 255, 0.015), rgba(255, 255, 255, 0.008));
                border: 1px solid rgba(255, 255, 255, 0.04);
            }

            .task.subtask::before,
            .task.subtask::after {
                display: none;
            }

            .subtask-toggle {
                font-size: 10px;
                padding: 4px 0;
                margin-top: 6px;
            }

            .form-col {
                min-width: 100%;
            }
        }

        @media (max-width: 400px) {
            .actions {
                flex-direction: column;
                gap: 6px;
            }

            .actions button {
                width: 100%;
                padding: 10px 12px;
                font-size: 13px;
                min-height: 40px;
            }

            .task {
                padding: 12px;
                margin-bottom: 2px;
            }

            .task .title {
                font-size: 15px;
                line-height: 1.2;
            }

            .task .desc {
                font-size: 13px;
                line-height: 1.3;
            }

            .right {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }

            .pill {
                align-self: flex-start;
                order: 0;
                padding: 5px 8px;
                font-size: 10px;
            }

            .actions {
                order: 1;
                width: 100%;
            }
        }

        a {
            color: var(--accent);
            text-decoration: none;
            transition: color 0.2s ease;
        }

        /* Custom Select Wrapper */
        .custom-select-wrapper {
            position: relative;
            width: 100%;
        }

        /* Hide native select */
        .custom-select-wrapper select {
            display: none;
        }

        .custom-select {
            background: var(--glass);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.04);
            border-radius: 8px;
            padding: 10px 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: clamp(14px, 3vw, 15px);
        }

        .custom-select::after {
            content: "▼";
            font-size: 0.8rem;
            pointer-events: none;
        }

        input,
        textarea,
        select,
        button,
        .custom-select,
        .custom-options div {
            font-family: 'Poppins', sans-serif;
        }

        .custom-options {
            position: absolute;
            top: 110%;
            left: 0;
            width: 100%;
            background: var(--glass);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.04);
            border-radius: 8px;
            overflow: hidden;
            display: none;
            z-index: 100;
        }

        .custom-options div {
            padding: 10px 12px;
            cursor: pointer;
            font-size: clamp(14px, 3vw, 15px);
        }

        .custom-options div:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .custom-options.open {
            display: block;
        }

        /* Custom Modal Styling */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: linear-gradient(145deg, rgba(15, 20, 23, 0.95), rgba(11, 15, 18, 0.98));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            transform: scale(0.9) translateY(20px);
            transition: all 0.3s ease;
        }

        .modal-overlay.show .modal {
            transform: scale(1) translateY(0);
        }

        .modal h3 {
            margin: 0 0 16px 0;
            color: #e6eef3;
            font-size: 18px;
            font-weight: 600;
        }

        .modal p {
            margin: 0 0 20px 0;
            color: var(--muted);
            font-size: 14px;
            line-height: 1.4;
        }

        .modal-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #e6eef3;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 20px;
            transition: all 0.2s ease;
            font-family: 'Poppins', sans-serif;
        }

        .modal-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(110, 231, 183, 0.15);
            background: rgba(255, 255, 255, 0.08);
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Poppins', sans-serif;
        }

        .modal-btn.primary {
            background: var(--accent);
            color: var(--bg);
        }

        .modal-btn.primary:hover {
            background: #5cd9a8;
            transform: translateY(-1px);
        }

        .modal-btn.secondary {
            background: rgba(255, 255, 255, 0.06);
            color: var(--muted);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-btn.secondary:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #e6eef3;
        }

        .modal-btn.danger {
            background: var(--danger);
            color: white;
        }

        .modal-btn.danger:hover {
            background: #ff5252;
            transform: translateY(-1px);
        }
    </style>
</head>

<body>
    <div id="app">
        <div class="wrap">
            <header>
                <div>
                    <h1>My Tasks</h1>
                    <div class="sub">Task's persist in your browser's local storage.</div>
                </div>
                <div>
                    <button id="clearLocal" class="btn small ghost">Clear all</button>
                </div>
            </header>
            <div style="font-size:13px;color:var(--muted);margin-top:10px">Active tasks (drag to reorder)</div>
            <div id="taskList" class="list" aria-live="polite"></div>
            <section class="panel">

                <form id="taskForm">
                    <div class="row">
                        <div class="form-col">
                            <label for="title">Task title</label>
                            <input id="title" type="text" placeholder="Short title" required />
                        </div>
                        <div class="form-col">
                            <label for="priority">Priority</label>
                            <div class="custom-select-wrapper">
                                <select id="priority">
                                    <option value="low">Low</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="high">High</option>
                                </select>
                                <div class="custom-select" id="fakeSelect">Medium</div>
                                <div class="custom-options" id="fakeOptions">
                                    <div data-value="low">Low</div>
                                    <div data-value="medium">Medium</div>
                                    <div data-value="high">High</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-col">
                        <label for="desc">Description <span
                                style="color:var(--muted);font-size:12px">(optional)</span></label>
                        <textarea id="desc" placeholder="Short notes..."></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="deadline">Deadline</label>
                            <input id="deadline" type="datetime-local" />
                        </div>
                        <div class="form-col">
                            <label for="file">Attach file</label>
                            <input id="file" type="file" />
                        </div>
                        <div class="form-col">
                            <div class="actions">
                                <button type="submit" class="btn">Add task</button>
                            </div>
                        </div>
                    </div>
                </form>
            </section>

            <footer class="sub">Made with ❤️ by <a href="https://github.com/AmarnathCJD">AmarnathCJD</a></footer>
        </div>
    </div>

    <script>
        let state = { tasks: [] };
        const els = {
            form: document.getElementById('taskForm'),
            title: document.getElementById('title'),
            file: document.getElementById('file'),
            desc: document.getElementById('desc'),
            deadline: document.getElementById('deadline'),
            priority: document.getElementById('priority'),
            taskList: document.getElementById('taskList'),
            clearLocal: document.getElementById('clearLocal')
        };

        function uid() { return Math.random().toString(36).slice(2, 9) }
        function loadLocal() {
            try {
                const raw = localStorage.getItem('local_tasks');
                if (raw) {
                    state = JSON.parse(raw);
                    // Ensure backward compatibility - add missing properties
                    state.tasks = state.tasks.map(task => ({
                        ...task,
                        subtasks: task.subtasks || [],
                        collapsed: task.collapsed || false,
                        parentId: task.parentId || null
                    }));
                }
            } catch { }
        }
        function saveLocal() {
            localStorage.setItem('local_tasks', JSON.stringify(state));
        }
        function addTask(obj, parentId = null) {
            const newTask = {
                id: uid(),
                title: obj.title || 'Untitled',
                desc: obj.desc || '',
                deadline: obj.deadline || null,
                priority: obj.priority || 'medium',
                fileUrl: obj.fileUrl || null,
                done: false,
                createdAt: new Date().toISOString(),
                parentId: parentId,
                subtasks: [],
                collapsed: false
            };

            if (parentId) {
                const parent = state.tasks.find(t => t.id === parentId);
                if (parent) {
                    parent.subtasks.push(newTask);
                }
            } else {
                state.tasks.push(newTask);
            }

            saveLocal(); render();
        }

        function removeTask(id, parentId = null) {
            if (parentId) {
                const parent = state.tasks.find(t => t.id === parentId);
                if (parent) {
                    parent.subtasks = parent.subtasks.filter(t => t.id !== id);
                }
            } else {
                state.tasks = state.tasks.filter(t => t.id !== id);
            }
            saveLocal(); render();
        }

        function toggleDone(id, parentId = null) {
            if (parentId) {
                const parent = state.tasks.find(t => t.id === parentId);
                if (parent) {
                    parent.subtasks = parent.subtasks.map(t => t.id === id ? { ...t, done: !t.done } : t);
                }
            } else {
                state.tasks = state.tasks.map(t => {
                    if (t.id === id) {
                        return { ...t, done: !t.done };
                    }
                    return t;
                });
            }
            saveLocal(); render();
        }

        function toggleCollapse(id) {
            state.tasks = state.tasks.map(t => t.id === id ? { ...t, collapsed: !t.collapsed } : t);
            saveLocal(); render();
        }
        function formatDeadline(dt) {
            if (!dt) return '—';
            try { return new Date(dt).toLocaleString(); } catch { return dt; }
        }

        function getCountdown(deadline) {
            if (!deadline) return null;

            const now = new Date();
            const deadlineDate = new Date(deadline);
            const diff = deadlineDate - now;

            if (diff <= 0) {
                return { text: 'Overdue!', class: 'urgent' };
            }

            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            let text = '';
            let className = '';

            if (days > 0) {
                text = `${days}d ${hours}h ${minutes}m left`;
                className = days <= 1 ? 'warning' : '';
            } else if (hours > 0) {
                text = `${hours}h ${minutes}m ${seconds}s left`;
                className = hours <= 6 ? 'urgent' : 'warning';
            } else if (minutes > 0) {
                text = `${minutes}m ${seconds}s left`;
                className = 'urgent';
            } else {
                text = `${seconds}s left`;
                className = 'urgent';
            }

            return { text, class: className };
        }
        function escapeHtml(s) {
            return (s || '').replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c]));
        }

        const realSelect = document.getElementById("priority");
        const fakeSelect = document.getElementById("fakeSelect");
        const fakeOptions = document.getElementById("fakeOptions");

        fakeSelect.addEventListener("click", () => {
            fakeOptions.classList.toggle("open");
        });

        fakeOptions.querySelectorAll("div").forEach(opt => {
            opt.addEventListener("click", () => {
                const value = opt.getAttribute("data-value");
                realSelect.value = value;
                fakeSelect.textContent = opt.textContent;
                fakeOptions.classList.remove("open");
            });
        });

        document.addEventListener("click", (e) => {
            if (!e.target.closest(".custom-select-wrapper")) {
                fakeOptions.classList.remove("open");
            }
        });

        // Make toggleCollapse globally accessible
        window.toggleCollapse = function (id) {
            state.tasks = state.tasks.map(t => t.id === id ? { ...t, collapsed: !t.collapsed } : t);
            saveLocal(); render();
        };

        // Custom Alert and Confirm Functions
        function createModal(title, message, buttons, inputPlaceholder = null) {
            return new Promise((resolve) => {
                const overlay = document.createElement('div');
                overlay.className = 'modal-overlay';
                
                const modal = document.createElement('div');
                modal.className = 'modal';
                
                const titleEl = document.createElement('h3');
                titleEl.textContent = title;
                modal.appendChild(titleEl);
                
                const messageEl = document.createElement('p');
                messageEl.textContent = message;
                modal.appendChild(messageEl);
                
                let input = null;
                if (inputPlaceholder) {
                    input = document.createElement('input');
                    input.className = 'modal-input';
                    input.placeholder = inputPlaceholder;
                    input.type = 'text';
                    modal.appendChild(input);
                }
                
                const buttonsContainer = document.createElement('div');
                buttonsContainer.className = 'modal-buttons';
                
                buttons.forEach(button => {
                    const btn = document.createElement('button');
                    btn.className = `modal-btn ${button.class}`;
                    btn.textContent = button.text;
                    btn.addEventListener('click', () => {
                        const result = input ? input.value : button.value;
                        closeModal(overlay);
                        resolve(result);
                    });
                    buttonsContainer.appendChild(btn);
                });
                
                modal.appendChild(buttonsContainer);
                overlay.appendChild(modal);
                document.body.appendChild(overlay);
                
                // Show modal with animation
                setTimeout(() => overlay.classList.add('show'), 10);
                
                // Focus input if exists
                if (input) {
                    setTimeout(() => input.focus(), 100);
                }
                
                // Close on overlay click
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        closeModal(overlay);
                        resolve(null);
                    }
                });
                
                // Close on escape key
                const handleEscape = (e) => {
                    if (e.key === 'Escape') {
                        closeModal(overlay);
                        resolve(null);
                        document.removeEventListener('keydown', handleEscape);
                    }
                };
                document.addEventListener('keydown', handleEscape);
            });
        }
        
        function closeModal(overlay) {
            overlay.classList.remove('show');
            setTimeout(() => {
                if (overlay.parentNode) {
                    overlay.parentNode.removeChild(overlay);
                }
            }, 300);
        }
        
        function customAlert(title, message) {
            return createModal(title, message, [
                { text: 'OK', class: 'primary', value: true }
            ]);
        }
        
        function customConfirm(title, message) {
            return createModal(title, message, [
                { text: 'Cancel', class: 'secondary', value: false },
                { text: 'OK', class: 'primary', value: true }
            ]);
        }
        
        function customPrompt(title, message, placeholder = '') {
            return createModal(title, message, [
                { text: 'Cancel', class: 'secondary', value: null },
                { text: 'OK', class: 'primary', value: 'input' }
            ], placeholder);
        }


        function render() {
            els.taskList.innerHTML = '';
            state.tasks.forEach(task => {
                renderTask(task);
                if (!task.collapsed && task.subtasks && task.subtasks.length > 0) {
                    task.subtasks.forEach(subtask => {
                        renderTask(subtask, task.id);
                    });
                }
            });
        }

        function renderTask(task, parentId = null) {
            const item = document.createElement('div');
            item.className = `task ${task.done ? 'done' : ''} ${parentId ? 'subtask' : ''}`;
            item.draggable = !task.done;
            item.dataset.id = task.id;
            if (parentId) item.dataset.parentId = parentId;

            item.addEventListener('dragstart', e => {
                item.classList.add('dragging');
                e.dataTransfer.setData('text/plain', JSON.stringify({ id: task.id, parentId }));
            });
            item.addEventListener('dragend', () => item.classList.remove('dragging'));
            item.addEventListener('dblclick', () => toggleDone(task.id, parentId));

            const meta = document.createElement('div');
            meta.className = 'meta';

            if (parentId) {
                // Simple subtask - only title, clickable to toggle done
                meta.innerHTML = `<div class="title" style="cursor: pointer;">${escapeHtml(task.title)}</div>`;
                meta.addEventListener('click', () => toggleDone(task.id, parentId));
                item.appendChild(meta);
            } else {
                // Full main task
                const countdown = getCountdown(task.deadline);
                const countdownHtml = countdown ?
                    `<div class="countdown ${countdown.class}">⏰ ${countdown.text}</div>` : '';

                const hasSubtasks = task.subtasks && task.subtasks.length > 0;

                meta.innerHTML = `<div class="title">${escapeHtml(task.title)}</div>
        <div class="desc">${escapeHtml(task.desc)}</div>
        <div style="margin-top:6px;font-size:12px;color:var(--muted)">Deadline: ${formatDeadline(task.deadline)}</div>
        ${countdownHtml}`;

                const right = document.createElement('div');
                right.className = 'right';
                const pr = document.createElement('div');
                pr.className = 'pill ' + (task.priority === 'low' ? 'prio-low' : task.priority === 'high' ? 'prio-high' : 'prio-med');
                pr.textContent = task.priority.toUpperCase();

                const actions = document.createElement('div');
                actions.className = 'actions';

                const doneBtn = document.createElement('button');
                doneBtn.className = 'btn small';
                doneBtn.textContent = task.done ? 'Undo' : 'Done';
                doneBtn.addEventListener('click', () => toggleDone(task.id, parentId));

                const del = document.createElement('button');
                del.className = 'btn small danger';
                del.textContent = 'Delete';
                del.addEventListener('click', async () => { 
                    if (await customConfirm('Delete Task', 'Are you sure you want to delete this task?')) {
                        removeTask(task.id, parentId);
                    }
                });                const addSubtaskBtn = document.createElement('button');
                addSubtaskBtn.className = 'btn small';
                addSubtaskBtn.textContent = '+ Sub';
                addSubtaskBtn.addEventListener('click', async () => {
                    const title = await customPrompt('Add Subtask', 'Enter the subtask title:', 'Subtask title...');
                    if (title && title.trim()) {
                        addTask({ title: title.trim() }, task.id);
                    }
                });

                actions.appendChild(doneBtn);
                actions.appendChild(del);
                actions.appendChild(addSubtaskBtn);

                right.appendChild(pr);
                right.appendChild(actions);

                item.appendChild(meta);
                item.appendChild(right);

                // Add collapse button below the main card if there are subtasks
                if (hasSubtasks) {
                    const collapseButton = document.createElement('button');
                    collapseButton.className = 'subtask-toggle';
                    collapseButton.textContent = `${task.collapsed ? '▶' : '▼'} ${task.subtasks.length} subtask${task.subtasks.length > 1 ? 's' : ''}`;
                    collapseButton.addEventListener('click', () => toggleCollapse(task.id));
                    item.appendChild(collapseButton);
                }

                if (task.fileUrl) {
                    const fileLink = document.createElement('a');
                    fileLink.href = task.fileUrl;
                    fileLink.textContent = '📎 Attached file';
                    fileLink.style.fontSize = '12px';
                    fileLink.style.color = 'var(--accent)';
                    fileLink.target = '_blank';
                    meta.appendChild(fileLink);
                }
            }

            // Drag and drop handling
            item.addEventListener('dragover', e => {
                e.preventDefault();
                const dragging = document.querySelector('.dragging');
                if (!dragging || dragging === item) return;
                const rect = item.getBoundingClientRect();
                const before = (e.clientY - rect.top) < rect.height / 2;
                if (before) item.parentNode.insertBefore(dragging, item);
                else item.parentNode.insertBefore(dragging, item.nextSibling);
            });

            item.addEventListener('drop', e => {
                e.preventDefault();
                // Reorganize tasks based on new order
                const ids = Array.from(els.taskList.children).map(ch => ({
                    id: ch.dataset.id,
                    parentId: ch.dataset.parentId || null
                }));

                // Rebuild task structure
                const newTasks = [];
                const processedSubtasks = new Set();

                ids.forEach(item => {
                    if (!item.parentId) {
                        const task = state.tasks.find(t => t.id === item.id);
                        if (task) {
                            newTasks.push({ ...task, subtasks: [] });
                        }
                    }
                });

                ids.forEach(item => {
                    if (item.parentId) {
                        const parentTask = newTasks.find(t => t.id === item.parentId);
                        const subtask = state.tasks.find(t => t.id === item.parentId)?.subtasks.find(s => s.id === item.id);
                        if (parentTask && subtask) {
                            parentTask.subtasks.push(subtask);
                        }
                    }
                });

                state.tasks = newTasks;
                saveLocal(); render();
            });

            els.taskList.appendChild(item);
        }

        els.clearLocal.addEventListener('click', async () => {
            if (await customConfirm('Clear All Tasks', 'Are you sure you want to clear all saved tasks? This action cannot be undone.')) {
                localStorage.removeItem('local_tasks');
                state = { tasks: [] };
                render();
            }
        });

        els.form.addEventListener('submit', async e => {
            e.preventDefault();
            const t = els.title.value.trim();
            if (!t) return;

            let fileUrl = null;
            if (els.file.files.length) {
                const file = els.file.files[0];
                const formData = new FormData();
                formData.append('file', file);

                try {
                    const res = await fetch('https://envs.sh', { method: 'POST', body: formData });
                    fileUrl = await res.text();
                    fileUrl = fileUrl.trim();
                } catch (err) {
                    await customAlert('Upload Failed', 'File upload failed. Please try again.');
                }
            }

            addTask({
                title: t,
                desc: els.desc.value.trim(),
                deadline: els.deadline.value || null,
                priority: els.priority.value,
                fileUrl
            });

            els.form.reset();
        });

        loadLocal();
        render();

        // Update countdowns every second for real-time updates
        setInterval(() => {
            render();
        }, 1000);
    </script>
</body>

</html>